# 黑洞光线追踪教程设计

## 教学目标

本教程旨在帮助学生：
1. 理解史瓦西黑洞的基本物理概念
2. 掌握光线追踪算法原理
3. 学习数值积分方法
4. 理解向量化/并行加速原理

## 设计理念

```
物理概念 → 数学推导 → 简单实现 → 优化加速 → 完整应用
```

循序渐进，每一步都有可视化和代码实践。

---

## 教程大纲

### 文件结构

```
docs/
├── tutorial/
│   ├── 00_绪论.ipynb
│   ├── 01_黑洞物理基础.ipynb
│   ├── 02_笛卡尔光线方程.ipynb
│   ├── 03_RK4数值积分.ipynb
│   ├── 04_单条光线追踪.ipynb
│   ├── 05_批量光线_向量化.ipynb
│   ├── 06_Taichi并行加速.ipynb
│   ├── 07_相机模型.ipynb
│   ├── 08_天空盒与纹理采样.ipynb
│   ├── 09_完整渲染器.ipynb
│   ├── 10_参数调优与实践.ipynb
│   └── images/
```

---

## 各章节详细设计

### 第0章：绪论

**学习目标**：了解项目全貌和学习路径

**内容**：
- 什么是光线追踪？
- 为什么黑洞需要光线追踪？
- 项目演示：展示最终渲染效果
- 学习路径图
- 环境配置

**作业**：运行 render.py 生成第一张图像

---

### 第1章：黑洞物理基础

**学习目标**：理解史瓦西黑洞的基本概念

**内容**：
- 1.1 什么是黑洞？
  - 引力坍缩
  - 事件视界
- 1.2 史瓦西度规
  - 线元表达式
  - 几何单位制
- 1.3 光子的运动
  - 零测地线
  - 光子球（r = 1.5 rs）
- 1.4 可视化解释
  - 引力透镜效应图解
  - 光子轨道可视化

**关键公式**：
```
ds² = -(1 - rs/r) dt² + (1 - rs/r)⁻¹ dr² + r² dθ² + r² sin²θ dφ²
rs = 2GM/c²  (史瓦西半径)
```

**作业**：计算太阳、地球的史瓦西半径

---

### 第2章：笛卡尔光线方程

**学习目标**：掌握光线方程的笛卡尔形式

**内容**：
- 2.1 为什么用笛卡尔坐标？
  - 球坐标的奇点问题
  - 计算效率对比
- 2.2 加速度公式推导
  - 有效势方法
  - 从 F = ma 到测地线方程
- 2.3 角动量守恒
  - 为什么 L² 守恒？
  - 初始计算一次即可
- 2.4 对比 JaeHyunLee94 实现

**关键公式**：
```
d²x/dλ² = -1.5 · L² · x / r⁵
L² = |v × x|²
```

**作业**：手工计算一条光线的初始 L² 值

---

### 第3章：RK4数值积分

**学习目标**：掌握常微分方程的数值解法

**内容**：
- 3.1 为什么需要数值积分？
  - 解析解不存在
  - 光线方程是二阶 ODE
- 3.2 欧拉法
  - 最简单的方法
  - 精度问题
- 3.3 RK4 公式推导
  - 四次采样
  - 加权平均
- 3.4 步长选择
  - 步长 vs 精度 vs 速度
  - 实验对比
- 3.5 代码实现

**代码示例**：
```python
def rk4_step(pos, vel, L2, dt):
    k1_v = dt * acceleration(pos, L2)
    k1_x = dt * vel
    # ... k2, k3, k4
    return new_pos, new_vel
```

**作业**：对比欧拉法与 RK4 的精度

---

### 第4章：单条光线追踪

**学习目标**：实现并可视化单条光线的追踪过程

**内容**：
- 4.1 初始化一条光线
  - 位置、方向、角动量
- 4.2 积分循环
  - 终止条件：capture / escape
- 4.3 可视化光线路径
  - 用 matplotlib 绘制轨迹
- 4.4 参数实验
  - 不同初始方向
  - 不同步长

**可视化效果**：
```
      y
      ↑
      |    ╭─────────────╮
      |   ╱               ╲
      |  ╱  光线路径       ╲
      | ╱                   ╲
      |╱        ●黑洞        ╲
      +───────────────────────→ x
```

**作业**：追踪一条刚好掠过光子球的光线

---

### 第5章：批量光线与向量化

**学习目标**：理解向量化加速原理

**内容**：
- 5.1 为什么要批量处理？
  - 单条光线太慢
  - 图像有数百万像素
- 5.2 向量化原理
  - NumPy 广播机制
  - 避免显式循环
- 5.3 Compact 算法
  - 维护活跃光线集合
  - 每步移除终止光线
- 5.4 性能对比
  - 单条循环 vs 批量向量化
  - 时间测量

**性能对比表**：
| 方法 | 640×360 时间 |
|------|-------------|
| 单条循环 | > 10 分钟 |
| 向量化 compact | ~10 秒 |

**作业**：测量不同分辨率的时间增长曲线

---

### 第6章：Taichi 并行加速

**学习目标**：理解并行计算原理

**内容**：
- 6.1 并行计算基础
  - SIMD / 多线程 / GPU
  - 数据并行 vs 任务并行
- 6.2 Taichi 简介
  - JIT 编译
  - kernel 函数
- 6.3 while_loop 并行
  - 每条光线独立循环
  - Taichi 自动并行
- 6.4 CPU vs GPU
  - 架构差异
  - 性能对比
- 6.5 代码实现

**性能对比**：
| 框架 | 640×360 时间 | 加速比 |
|------|-------------|--------|
| NumPy compact | ~10s | 1x |
| Taichi CPU | ~0.3s | ~30x |
| Taichi GPU | （如有） | 更快 |

**作业**：部署 Taichi 并测量性能

---

### 第7章：相机模型

**学习目标**：理解针孔相机模型

**内容**：
- 7.1 针孔相机原理
  - 小孔成像
  - 图像平面
- 7.2 相机坐标系
  - position, forward, right, up
- 7.3 视野角 FOV
  - FOV 对图像的影响
  - 广角 vs 长焦
- 7.4 像素到光线映射
  - 从像素坐标到世界坐标
  - 公式推导

**公式**：
```
image_plane_height = 2 * tan(fov / 2)
pixel_pos = camera_pos + direction_to_pixel
ray_dir = normalize(pixel_pos - camera_pos)
```

**可视化**：
```
        图像平面
        ┌─────────┐
        │ ● ● ● ● │  ← 像素
        │ ● ● ● ● │
        └────┬────┘
             │
             │ (焦距)
             │
           ○ 相机
   
   每个像素对应一条光线
```

**作业**：改变 FOV 观察效果变化

---

### 第8章：天空盒与纹理采样

**学习目标**：理解环境映射和纹理采样

**内容**：
- 8.1 等距柱状投影
  - 从球面到平面
  - 经纬度映射
- 8.2 纹理坐标计算
  - 方向向量 → (θ, φ)
  - 归一化到 [0, 1]
- 8.3 采样方法
  - 最近邻采样
  - 双线性插值
- 8.4 程序生成星空
  - 星云噪声
  - 高斯光点

**公式**：
```
θ = arccos(dz)
φ = atan2(dy, dx)
u = φ / (2π)
v = θ / π
```

**作业**：自定义一个天空盒纹理

---

### 第9章：完整渲染器

**学习目标**：整合所有模块

**内容**：
- 9.1 渲染管线
  - 相机 → 光线 → 积分 → 着色
- 9.2 代码架构
  - 模块划分
  - 函数职责
- 9.3 参数配置
  - 命令行参数
  - 默认值选择
- 9.4 生成最终图像
  - FHD/4K 渲染
  - 保存输出

**渲染管线图**：
```
+----------+     +----------+     +----------+
|  相机    | --> |  光线    | --> |  积分    |
|  参数    |     |  生成    |     |  RK4     |
+----------+     +----------+     +----------+
                                       |
                                       v
+----------+     +----------+     +----------+
|  保存    | <-- |  着色    | <-- |  分类    |
|  图像    |     |  采样    |     |  光线    |
+----------+     +----------+     +----------+
```

**作业**：渲染一张自定义视角的黑洞图像

---

### 第11章：吸积盘渲染

**学习目标**：实现黑洞吸积盘的视觉效果

**内容**：
- 11.1 吸积盘物理基础
  - 温度剖面
  - 开普勒旋转
  - 多普勒效应
- 11.2 表面渲染 vs 体积渲染
  - 交点检测算法
  - 纹理映射
- 11.3 多普勒 Beaming
  - 蓝移与红移
  - 亮度调制
  - 颜色偏移
- 11.4 纹理生成
  - 程序化噪声
  - 边缘软化

**关键公式**：
```
v_orbital = sqrt(1/(2r))           # 开普勒速度
doppler = 1 / (1 - v · ray_dir)    # 多普勒因子
brightness = doppler³              # 相对论 beaming
```

**多普勒颜色偏移**：
```
shift = doppler - 1.0
r = color.r * (1 - shift * 0.6)    # 蓝移时红减少
b = color.b * (1 + shift * 0.4)    # 蓝移时蓝增加
```

**作业**：调整吸积盘参数，观察多普勒效应

---

### 第12章：后处理效果

**学习目标**：理解图像后处理原理

**内容**：
- 12.1 什么是后处理？
  - 渲染与着色的分离
  - 2D 图像操作
- 12.2 Bloom 泛光效果
  - 高斯模糊
  - 阈值提取
  - 加法混合
- 12.3 分离式 Bloom
  - 为什么要分离？
  - 只对吸积盘做 bloom
  - 保持背景清晰
- 12.4 实现细节
  - 亮度阈值
  - 模糊核大小
  - 强度控制

**分离式 Bloom 管线**：
```
渲染Kernel → image_field (背景)
           → disk_layer_field (吸积盘)
                ↓
           Bloom Kernel → disk_bloom
                ↓
           final = bg + disk + disk_bloom
```

**参数实验**：
| threshold | blur_sigma | intensity | 效果 |
|-----------|------------|-----------|------|
| 0         | 64         | 0.1       | 柔和光晕 |
| 0.5       | 8          | 0.6       | 强烈过曝 |

**作业**：调优 Bloom 参数，比较效果差异

---

## 实施计划

| 阶段 | 内容 | 预计时间 |
|------|------|---------|
| 第一阶段 | 第0-3章（基础） | 2 周 |
| 第二阶段 | 第4-8章（算法+渲染） | 3 周 |
| 第三阶段 | 第9-12章（应用+后处理） | 3 周 |

---

## 更新记录

- v1.1 (2026-02-28): 新增第11章（吸积盘渲染）、第12章（后处理效果）
- v1.0 (2026-02-26): 初始设计
