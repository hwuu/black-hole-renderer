## 开发规范

### 流程控制

1. 方案讨论阶段不要修改代码，方案确定后才可以动手
2. 方案讨论需要双方都没疑问才输出具体方案文档
3. 严格按步骤执行，每次只专注当前步骤。不允许跨步骤实现或"顺便"完成其他任务。每步完成后汇报，等待 Review 确认后进入下一步
4. 没有我的明确指令不许 commit / push

### 方案设计

5. 方案评估主动思考需求边界，合理质疑方案完善性。方案需包含：重要逻辑的实现思路、按依赖关系拆解排序、修改/新增文件路径、测试要点
6. 遇到争议或不确定性主动告知我，让我决策而不是默认采用一种方案
7. 文档中流程框图文字用英文，框线要对齐；其余内容保持中文

### 编码规范

8. 最小改动原则，除非我主动要求优化或重构
9. 优先参考和复用现有代码风格，避免重复造轮子
10. 不要在源码中插入 mock 的硬编码数据
11. 使用 TDD 开发模式，小步快跑，每一步都测试，保证不影响现有用例
12. 及时在 `tests/unit` 中添加单元测试
13. 测试完后清理测试文件
14. bug 修复超过 2 次失败，主动添加关键日志再尝试，修复后清除日志
15. 使用中文回答
16. 同步更新相关文档

### 提交规范

17. 提交前先梳理内容，等待 Review 确认后才能提交
18. commit message 使用中文
19. 每个 commit 必须添加 `Co-Authored-By` trailer

### 踩坑记录

21. 重试过 2 次以上的环境配置问题或重复犯错的问题，记录在本文件

22. **多普勒效应颜色/亮度方向问题** (待深入分析)
    - 现象：直觉认为蓝移应偏蓝、红移应偏红，但实际效果相反
    - 最终修正：
      - 盘旋转方向：`v_hat = r_hat × disk_normal`（而非 `disk_normal × r_hat`）
      - 颜色：蓝移(neg_shift>0)时 r_scale 增大偏红，红移(pos_shift>0)时 b_scale 增大偏蓝
      - 亮度：由 g 因子自动决定，g>1 亮，g<1 暗
    - 待分析：为什么物理正确的多普勒效应在视觉上呈现"反直觉"的颜色？
      - 可能方向：shift 的定义是否有误？g>1 实际对应什么物理条件？
      - 文件位置：`render.py:716-741` 的 `apply_g_factor` 函数

---

### 常用命令

```bash
# 渲染测试图像
python render.py --pov 20 0 2 --fov 60 --ar1 2 --ar2 10 --disk_tilt 20 --resolution hd -o output/*.png
```
